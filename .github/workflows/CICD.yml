name: Dev Worflow -  Only Test

on: [push]

jobs:
    health-checkup-job: #Check the healthy by running tests
        runs-on: ubuntu-latest
        strategy:
            max-parallel: 4
            matrix:
                python-version: [3.8]
        steps:
            - uses: actions/checkout@v2
            - name: Set up Python ${{ matrix.python-version }}
              uses: actions/setup-python@v2
              with:
                  python-version: ${{ matrix.python-version }}
            - name: Install Dependencies
              run: |
                  python -m pip install --upgrade pip
                  pip install poetry
                  poetry install
            # - name: Run migrations
            #   run: |
            #       cd folio_backend && python manage.py makemigrations --noinput
            #       cd folio_backend && python manage.py migrate --noinput
            # - name: Run Tests
            #   run: |
            #       cd folio_backend && poetry run python manage.py test
            # - name: Check Syntax #We are just testing the syntax in names app; pycodestyle uses pep8 conventions of max line length of 79 characters while Django recommends 119 characters
            #   run: pycodestyle --statistics names

    # deploy-job:
    #     runs-on: ubuntu-latest
    #     needs: [health-checkup-job]
    #     if: ${{ github.event_name == 'push' }}
    #     steps:
    #         - name: Install Dependencies
    #           run: |
    #               sudo apt-get update -qy
    #               sudo apt-get install -y ruby-dev
    #               sudo gem install dpl
    #               wget -qO- https://cli-assets.heroku.com/install-ubuntu.sh | sh
    #         - name: Deploy
    #           run: |
    #               sudo dpl --provider=heroku --app=${{secrets.HEROKU_APP_NAME}} --api-key=${{secrets.HEROKU_API_KEY}}
    #               export HEROKU_API_KEY=${{secrets.HEROKU_API_KEY}}
    #               heroku run --app ${{secrets.HEROKU_APP_NAME}} python manage.py migrate
    # deploy-job:
    #     runs-on: ubuntu-latest
    #     if: ${{ github.event_name == 'push' }}
    #     steps:
    #         - uses: actions/checkout@v2
    #         - uses: akhileshns/heroku-deploy@v3.12.12 # This is the action
    #             with:
    #                 heroku_api_key: ${{secrets.HEROKU_API_KEY}}
    #                 heroku_app_name: ${{secrets.HEROKU_APP_NAME}} #Must be unique in Heroku
    #                 heroku_email: "ntu1101sdm.finalproj@gmail.com"
    #                 branch: staging
    heroku_git_deploy_job:
      runs-on: ubuntu-latest
      name: Git Deploy job- A job to deploy django app to heroku using git
      steps:
        - name: Checkout
          uses: actions/checkout@v2
        - name: Add remote origin
          run: |
            git remote add heroku https://heroku:${{ secrets.HEROKU_API_KEY }}@git.heroku.com/${{ secrets.HEROKU_APP_NAME }}.git
        - name: Deploy django to heroku
          uses: akhileshns/heroku-deploy@v3.12.12
          with: 
            heroku_app_name : ${{ secrets.HEROKU_APP_NAME }}
            heroku_api_key: ${{ secrets.HEROKU_API_KEY }}
            heroku_email_address: 'ntu1101sdm.finalproj@gmail.com'
            use_git: true
            branch: staging
            force_push: true
        - name: Run migration
          run: heroku run python manage.py migrate
